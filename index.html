<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã¾ã£ã¡ã‚ƒAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* èƒŒæ™¯å…¨ä½“ã‚’è–„ã„ã‚°ãƒªãƒ¼ãƒ³ã« */
            background-color: #f0fff4; 
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 600px; /* UIã«åˆã‚ã›ã¦å¹…ã‚’å°‘ã—ç‹­ã */
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05); /* å½±ã‚’æ§ãˆã‚ã« */
            padding: 30px;
            margin-top: 50px;
            border: 1px solid #c6f6d5; /* è–„ã„ç·‘ã®æ ç·šã‚’è¿½åŠ  */
        }
        .header {
            color: #38a169; /* Matcha Green */
            text-align: center;
            font-size: 2.25rem; /* å¤§ãã‚ã®ãƒ•ã‚©ãƒ³ãƒˆ */
            font-weight: 700;
            padding-bottom: 20px;
            margin-bottom: 0px;
        }
        .chat-area {
            height: 350px;
            overflow-y: auto;
            /* æ ç·šã‚’ãªãã—ã€èƒŒæ™¯ã¯ç™½ã« */
            border: none; 
            border-radius: 10px;
            padding: 15px 0; /* å·¦å³ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
            background-color: #ffffff;
            margin-bottom: 10px;
        }
        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºã‚’èª¿æ•´ */
        .message-user {
            background-color: #e6fffa;
            color: #2c7a7b;
            padding: 8px 12px;
            border-radius: 15px 15px 5px 15px;
            margin-bottom: 10px;
            max-width: 85%;
            margin-left: auto;
            text-align: left; /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å·¦æƒãˆ */
            font-size: 0.95rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .message-ai {
            background-color: #c6f6d5;
            color: #38a169;
            padding: 8px 12px;
            border-radius: 15px 15px 15px 5px;
            margin-bottom: 10px;
            max-width: 85%;
            margin-right: auto;
            text-align: left;
            font-size: 0.95rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .message-system {
            text-align: center;
            color: #a0aec0;
            font-size: 0.8rem;
            margin: 20px 0;
            font-style: italic;
        }
        .input-prompt-label {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 5px;
            display: block;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        #input_field_id {
            padding: 12px;
            border: 1px solid #a0aec0; /* ç°è‰²ã®æ ç·š */
            border-radius: 5px;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06);
        }
        #input_field_id:focus {
            border-color: #38a169;
            box-shadow: 0 0 0 3px rgba(56, 161, 105, 0.3); /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®ç·‘è‰²ã®å…‰ */
            outline: none;
        }
        .button-primary {
            /* é€ä¿¡ãƒœã‚¿ãƒ³ã¯å…¨å¹…ã€ç”»åƒã®è‰²ã«è¿‘ã¥ã‘ã‚‹ */
            background-color: #68b23c; 
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            transition: background-color 0.3s;
            width: 100%;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .button-primary:hover:not(:disabled) {
            background-color: #559330;
        }
        .button-primary:disabled {
            background-color: #a3c988;
            cursor: not-allowed;
        }
        /* å±¥æ­´ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã¯å‰Šé™¤ã™ã‚‹ (ç”»åƒã«ãªã„ã®ã§) */
        
        #loading_message {
            color: #38a169;
            font-style: italic;
            margin-top: 10px;
            text-align: center;
        }
        .hidden {
            display: none;
        }
        /* ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
        .server-status {
            display: none !important;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="header">ã¾ã£ã¡ã‚ƒAI ğŸµ</h1>
    
    <!-- ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹è¡¨ç¤ºã‚¨ãƒªã‚¢ (éè¡¨ç¤º) -->
    <div id="server_status" class="server-status"></div>

    <!-- ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="output_area_id" class="chat-area">
        <div class="message-system">
            ã•ã‚ã€è³ªå•ã‚’å…¥åŠ›ã—ã¦ã€ã¾ã£ã¡ã‚ƒAIã¨ä¼šè©±ã‚’å§‹ã‚ã‚ˆã†ï¼
        </div>
    </div>

    <!-- è³ªå•å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <label for="input_field_id" class="input-prompt-label">è³ªå•ã‚’å…¥åŠ›ã—ã¦ã­ï¼</label>
    <div class="input-group">
        <input type="text" id="input_field_id" placeholder="" class="text-base" onkeypress="handleKeyPress(event)">
        <button id="submit_button" class="button-primary" onclick="sendQuestionToAI()">ã¾ã£ã¡ã‚ƒAIã«é€ä¿¡</button>
    </div>
    
    <!-- å±¥æ­´ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ (éè¡¨ç¤ºã«ã™ã‚‹) -->
    <!-- <div class="flex justify-end">
        <button id="clear_history_button" class="button-secondary text-sm" onclick="clearHistory()">
            <span id="clear_history_text">ğŸµ å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ (0ä»¶)</span>
        </button>
    </div> -->

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="loading_message" class="hidden">
        AIãŒ Core i7 ã®åŠ›ã§è€ƒãˆã¦ã‚‹ã‚ˆ... ğŸµğŸ’­
    </div>
</div>

<script>
// --- 1. å®šæ•°ã¨åˆæœŸè¨­å®š ---

const HISTORY_STORAGE_KEY = 'matcha_ai_chat_history'; // LocalStorageã®ã‚­ãƒ¼
const SERVER_URL = `http://localhost:8001/generate`; 

// UIè¦ç´ ã®å–å¾—
const inputField = document.getElementById('input_field_id');
const outputArea = document.getElementById('output_area_id');
const loadingMessage = document.getElementById('loading_message');
const submitButton = document.getElementById('submit_button');
// serverStatusã¨clearHistoryButtonã¯UIã‹ã‚‰å‰Šé™¤/éè¡¨ç¤ºã«ã—ãŸãŒã€JavaScriptã‹ã‚‰ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«æ®‹ã™
const serverStatus = document.getElementById('server_status'); 
// const clearHistoryButton = document.getElementById('clear_history_button');
// const clearHistoryText = document.getElementById('clear_history_text');

// ä¼šè©±å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹ãƒªã‚¹ãƒˆ (LocalStorageã‹ã‚‰åˆæœŸåŒ–ã•ã‚Œã‚‹)
let conversationHistory = [];

// --- 2. å±¥æ­´ç®¡ç†é–¢æ•°ï¼ˆLocalStorageé–¢é€£ï¼‰ ---

// å±¥æ­´ã‚’LocalStorageã«ä¿å­˜ã™ã‚‹é–¢æ•°
function saveHistory() {
    try {
        localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(conversationHistory));
        // updateHistoryCount(); // UIã‹ã‚‰ä»¶æ•°è¡¨ç¤ºã‚’å‰Šé™¤
    } catch (e) {
        console.error("LocalStorageã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
    }
}

// å±¥æ­´ã‚’LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿ã€ç”»é¢ã«è¡¨ç¤ºã™ã‚‹é–¢æ•°
function initializeHistory() {
    const storedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
    if (storedHistory) {
        try {
            conversationHistory = JSON.parse(storedHistory);
            // å±¥æ­´ã‚’ç”»é¢ã«å†æç”»
            outputArea.innerHTML = ''; // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            conversationHistory.forEach(msg => {
                displayMessage(msg.role, msg.content); 
            });
            outputArea.scrollTop = outputArea.scrollHeight;
            // updateHistoryCount(); // UIã‹ã‚‰ä»¶æ•°è¡¨ç¤ºã‚’å‰Šé™¤
            return true; // å±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã 
        } catch (e) {
            console.error("LocalStorageã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
            conversationHistory = []; // å¤±æ•—ã—ãŸã‚‰åˆæœŸåŒ–
            return false;
        }
    }
    return false; // å±¥æ­´ãŒãªã‹ã£ãŸ
}

// å±¥æ­´ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•° (æ©Ÿèƒ½ã¯æ®‹ã™)
function clearHistory() {
    if (confirm('æœ¬å½“ã«ä¼šè©±å±¥æ­´ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.removeItem(HISTORY_STORAGE_KEY);
        conversationHistory = [];
        outputArea.innerHTML = `
            <div class="message-system">
                ã•ã‚ã€è³ªå•ã‚’å…¥åŠ›ã—ã¦ã€ã¾ã£ã¡ã‚ƒAIã¨ä¼šè©±ã‚’å§‹ã‚ã‚ˆã†ï¼
            </div>
        `;
        // updateHistoryCount(); // UIã‹ã‚‰ä»¶æ•°è¡¨ç¤ºã‚’å‰Šé™¤
        outputArea.scrollTop = outputArea.scrollHeight;
    }
}

/* // å±¥æ­´ã®ä»¶æ•°ã‚’æ›´æ–°ã™ã‚‹é–¢æ•° (UIã‹ã‚‰å‰Šé™¤)
function updateHistoryCount() {
    const count = conversationHistory.length;
    clearHistoryText.innerText = `ğŸµ å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ (${count}ä»¶)`;
} */

// --- 3. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

// HTMLã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function displayMessage(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.className = role === 'user' ? 'message-user' : 'message-ai';
    messageDiv.innerText = content;
    outputArea.appendChild(messageDiv);
    outputArea.scrollTop = outputArea.scrollHeight; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸‹ã¸
}

// ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° (UIã‹ã‚‰å‰Šé™¤ã—ãŸãŒã€ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†ã¨ã—ã¦æ®‹ã™)
function updateServerStatus(isSuccess) {
    if (isSuccess) {
        // æˆåŠŸæ™‚ã¯ä½•ã‚‚ã—ãªã„
        serverStatus.innerHTML = ``;
    } else {
         // ã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿è¡¨ç¤º
        serverStatus.innerHTML = `
            <span class="font-bold">âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼</span> ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã­ã€‚
        `;
        serverStatus.style.backgroundColor = '#fefcbf'; 
        serverStatus.style.color = '#9f580a';
        serverStatus.style.display = 'block'; // ã‚¨ãƒ©ãƒ¼æ™‚ã ã‘è¡¨ç¤ºã‚’æˆ»ã™
    }
}

// Enterã‚­ãƒ¼ã§ã®é€ä¿¡ã‚’å¯èƒ½ã«ã™ã‚‹
function handleKeyPress(event) {
    if (event.key === 'Enter') {
        event.preventDefault(); // æ”¹è¡Œã‚’é˜²ã
        sendQuestionToAI(); 
    }
}

// --- 4. ãƒ¡ã‚¤ãƒ³ã®é€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå˜ä¸€ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šï¼‹å±¥æ­´ä¿å­˜ï¼‰ ---

async function sendQuestionToAI() {
    const prompt = inputField.value.trim();
    if (!prompt) {
        return;
    }
    
    const userMessage = { role: "user", content: prompt };
    
    // ç”»é¢ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    displayMessage('user', prompt); 
    inputField.value = '';

    // ğŸ¢ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹
    loadingMessage.classList.remove('hidden');
    submitButton.disabled = true;
    
    const requestData = {
        prompt: prompt,
        max_tokens: 500,
        temperature: 0.7,
        // éå»ã®å±¥æ­´ã‚’é€ã‚‹
        history: conversationHistory
    };

    let successful = false;

    try {
        const response = await fetch(SERVER_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            // ã‚µãƒ¼ãƒãƒ¼ã¯å¿œç­”ã—ãŸãŒã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãŒè¿”ã£ã¦ããŸï¼ˆä¾‹: 500ã‚¨ãƒ©ãƒ¼ï¼‰
            throw new Error(`AIã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¨ãƒ©ãƒ¼å¿œç­”: ${response.status}`);
        }

        const data = await response.json();
        
        // æˆåŠŸï¼
        successful = true;
        const aiResponseText = data.response;
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨AIå¿œç­”ã‚’æ­£å¼ãªå±¥æ­´ã«è¿½åŠ 
        const aiMessage = { role: "assistant", content: aiResponseText };
        conversationHistory.push(userMessage); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å±¥æ­´ã«è¿½åŠ ï¼
        conversationHistory.push(aiMessage);
        
        // LocalStorageã«ä¿å­˜ï¼
        saveHistory(); 

        // ç”»é¢ã«AIå¿œç­”ã‚’è¡¨ç¤º
        displayMessage('ai', aiResponseText); 
        updateServerStatus(true); // æˆåŠŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

    } catch (error) {
        // ã‚µãƒ¼ãƒãƒ¼ã¨é€šä¿¡ã§ããªã‹ã£ãŸã€ã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ãŸ
        console.error(`ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—:`, error.message);
        const errorMessage = 'ã”ã‚ã‚“ï¼AIã‚µãƒ¼ãƒãƒ¼ã¨é€šä¿¡ã§ããªã‹ã£ãŸã‚ˆ...ğŸ˜­ ã‚µãƒ¼ãƒãƒ¼ãŒå‹•ã„ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã­ï¼';
        displayMessage('system', errorMessage);
        updateServerStatus(false); // å¤±æ•—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    }
    
    loadingMessage.classList.add('hidden');
    submitButton.disabled = false;
}

// --- 5. åˆæœŸãƒã‚§ãƒƒã‚¯ã¨å±¥æ­´ãƒ­ãƒ¼ãƒ‰ ---
window.onload = () => {
    // å±¥æ­´ã‚’LocalStorageã‹ã‚‰èª­ã¿è¾¼ã‚€
    const loaded = initializeHistory(); 

    // å±¥æ­´ãŒãªã‹ã£ãŸã‚‰ã€åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    if (!loaded) {
        outputArea.innerHTML = `
            <div class="message-system">
                ã•ã‚ã€è³ªå•ã‚’å…¥åŠ›ã—ã¦ã€ã¾ã£ã¡ã‚ƒAIã¨ä¼šè©±ã‚’å§‹ã‚ã‚ˆã†ï¼
            </div>
        `;
    }
    
    // æˆåŠŸæ™‚ã®ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹è¡¨ç¤ºã¯è¡Œã‚ãªã„

    // å±¥æ­´ä»¶æ•°ã‚’æ›´æ–°ã®ä»£ã‚ã‚Šã«ã€ã‚¯ãƒªã‚¢æ©Ÿèƒ½ã®åˆæœŸåŒ–ã‚’è¡Œã† (ç”»åƒã«ã¯ãªã„ãŒã€æ©Ÿèƒ½ã¯æ®‹ã™)
    // const clearButton = document.getElementById('clear_history_button');
    // if (clearButton) {
    //     clearButton.onclick = clearHistory;
    // }
};

</script>
</body>
</html>
